"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var THREE = require("../../utils/three.min.js");
var cameraConfig = {
    flag: true,
    frame: {
        data: new Uint8Array(288 * 352),
        width: 0,
        height: 0
    },
};
var camera, renderer, scene;
Page({
    data: {
        frameSize: "small"
    },
    onLoad: function () {
        this.frameSizeInit();
    },
    onReady: function () {
        var that = this;
        var frameCount = 0;
        this.webglInit();
        var listener = wx.createCameraContext().onCameraFrame(function (res) {
            var timeStart = Date.now();
            if (cameraConfig.flag === false)
                return;
            cameraConfig.flag = false;
            cameraConfig.frame.data = new Uint8Array(res.data);
            that.handleFrame();
            console.log(frameCount++);
            console.log("FPS:", 60 * 1000 / (Date.now() - timeStart));
        });
    },
    handleFrame: function () {
        var geometry = new THREE.PlaneGeometry(cameraConfig.frame.width, cameraConfig.frame.height);
        var texture = new THREE.DataTexture(cameraConfig.frame.data, cameraConfig.frame.width, cameraConfig.frame.height, THREE.RGBAFormat);
        var tex_material = new THREE.MeshPhongMaterial({
            map: texture,
            side: THREE.DoubleSide
        });
        geometry.translate(cameraConfig.frame.width / 2, cameraConfig.frame.height / 2, 0);
        geometry.rotateX(Math.PI);
        var mesh = new THREE.Mesh(geometry, tex_material);
        scene.add(mesh);
        renderer.render(scene, camera);
        cameraConfig.flag = true;
    },
    webglInit: function () {
        wx.createSelectorQuery().select('#canvasId')
            .node()
            .exec(function (res) {
            var webcanvas = res[0].node;
            var k = cameraConfig.frame.width / cameraConfig.frame.height;
            var s = cameraConfig.frame.height / 2;
            camera = new THREE.OrthographicCamera(-s * k, s * k, s, -s, 1, 155);
            var x = cameraConfig.frame.width / 2;
            var y = -1 * cameraConfig.frame.height / 2;
            camera.position.set(x, y, 150);
            camera.lookAt(x, y, 0);
            renderer = new THREE.WebGLRenderer({
                canvas: webcanvas,
            });
            var ambient = new THREE.AmbientLight(0xF5F5F5);
            scene = new THREE.Scene();
            scene.add(ambient);
        });
    },
    frameSizeInit: function () {
        if (this.data.frameSize === "small") {
            cameraConfig.frame.width = 288;
            cameraConfig.frame.height = 352;
        }
        else if (this.data.frameSize === "medium") {
            cameraConfig.frame.width = 480;
            cameraConfig.frame.height = 640;
        }
        else if (this.data.frameSize === "large") {
            cameraConfig.frame.width = 720;
            cameraConfig.frame.height = 1280;
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGdEQUFrRDtBQUdsRCxJQUFJLFlBQVksR0FBRztJQUNqQixJQUFJLEVBQUUsSUFBSTtJQUNWLEtBQUssRUFBRTtRQUNMLElBQUksRUFBRSxJQUFJLFVBQVUsQ0FBQyxHQUFHLEdBQUMsR0FBRyxDQUFDO1FBQzdCLEtBQUssRUFBRSxDQUFDO1FBQ1IsTUFBTSxFQUFFLENBQUM7S0FDVjtDQUNGLENBQUM7QUFDRixJQUFJLE1BQVcsRUFBRSxRQUFhLEVBQUUsS0FBVSxDQUFDO0FBQzNDLElBQUksQ0FBQztJQUNILElBQUksRUFBRTtRQUNKLFNBQVMsRUFBRSxPQUFPO0tBQ25CO0lBQ0QsTUFBTTtRQUNKLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN2QixDQUFDO0lBQ0QsT0FBTztRQUNMLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQztRQUNoQixJQUFJLFVBQVUsR0FBRyxDQUFDLENBQUM7UUFDbkIsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ2pCLElBQUksUUFBUSxHQUFHLEVBQUUsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDLGFBQWEsQ0FBQyxVQUFDLEdBQUc7WUFDeEQsSUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQzNCLElBQUcsWUFBWSxDQUFDLElBQUksS0FBSyxLQUFLO2dCQUM1QixPQUFPO1lBQ1QsWUFBWSxDQUFDLElBQUksR0FBRyxLQUFLLENBQUM7WUFDMUIsWUFBWSxDQUFDLEtBQUssQ0FBQyxJQUFJLEdBQUcsSUFBSSxVQUFVLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ25ELElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNuQixPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUM7WUFDMUIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFN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QyxPQUFPLENBQUMsQ0FBQztRQUNyQixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFDQyxhQUFhO1FBQ1gsSUFBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsS0FBSyxPQUFPLEVBQUM7WUFDakMsWUFBWSxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFDO1lBQy9CLFlBQVksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQztTQUNqQzthQUFNLElBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEtBQUssUUFBUSxFQUFDO1lBQ3pDLFlBQVksQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLEdBQUcsQ0FBQztZQUMvQixZQUFZLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxHQUFHLENBQUM7U0FDakM7YUFBTSxJQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxLQUFLLE9BQU8sRUFBQztZQUN4QyxZQUFZLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxHQUFHLENBQUM7WUFDL0IsWUFBWSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO1NBQ2xDO0lBQ0gsQ0FBQztDQUNGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFRIUkVFIGZyb20gXCIuLi8uLi91dGlscy90aHJlZS5taW4uanNcIjtcbi8vIC8v6I635Y+W5bqU55So5a6e5L6LYXBwXG4vLyBjb25zdCBhcHAgPSBnZXRBcHA8SUFwcE9wdGlvbj4oKVxubGV0IGNhbWVyYUNvbmZpZyA9IHtcbiAgZmxhZzogdHJ1ZSwgICAgICAgICAgICAgICAgICAgICAgICAgICAvL+aYr+WQpuiOt+WPluS4i+S4gOS4quWunuaXtuW4pyBcbiAgZnJhbWU6IHsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL+WunuaXtuW4p+aVsOaNrlxuICAgIGRhdGE6IG5ldyBVaW50OEFycmF5KDI4OCozNTIpLFxuICAgIHdpZHRoOiAwLFxuICAgIGhlaWdodDogMFxuICB9LCAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbn07XG5sZXQgY2FtZXJhOiBhbnksIHJlbmRlcmVyOiBhbnksIHNjZW5lOiBhbnk7ICAgLy90aHJlZS5qc+ebuOWFs+eahOS4ieWkp+imgee0oFxuUGFnZSh7XG4gIGRhdGE6IHtcbiAgICBmcmFtZVNpemU6IFwic21hbGxcIlxuICB9LFxuICBvbkxvYWQoKSB7XG4gICAgdGhpcy5mcmFtZVNpemVJbml0KCk7ICAgIC8v6Ieq5Yqo6YCC6YWN5a6e5pe25bin55qE5a696auYXG4gIH0sXG4gIG9uUmVhZHkoKSB7XG4gICAgbGV0IHRoYXQgPSB0aGlzO1xuICAgIGxldCBmcmFtZUNvdW50ID0gMDtcbiAgICB0aGlzLndlYmdsSW5pdCgpOyAgICAgICAgICAgICAgICAgIC8vd2ViZ2zliJ3lp4vljJZcbiAgICBsZXQgbGlzdGVuZXIgPSB3eC5jcmVhdGVDYW1lcmFDb250ZXh0KCkub25DYW1lcmFGcmFtZSgocmVzKSA9PiB7XG4gICAgICBsZXQgdGltZVN0YXJ0ID0gRGF0ZS5ub3coKTtcbiAgICAgIGlmKGNhbWVyYUNvbmZpZy5mbGFnID09PSBmYWxzZSkgXG4gICAgICAgIHJldHVybjtcbiAgICAgIGNhbWVyYUNvbmZpZy5mbGFnID0gZmFsc2U7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL+eri+WNs+WBnOatouS4i+S4gOW4p+eahOiOt+WPlu+8jOetieW+heW9k+WJjeW4p+WkhOeQhuWQju+8jOWGjeWkhOeQhuS4i+S4gOW4p1xuICAgICAgY2FtZXJhQ29uZmlnLmZyYW1lLmRhdGEgPSBuZXcgVWludDhBcnJheShyZXMuZGF0YSk7ICAgIC8v5pu05paw5a6e5pe25bin55qE5Zu+5YOP5pWw5o2uXG4gICAgICB0aGF0LmhhbmRsZUZyYW1lKCk7XG4gICAgICBjb25zb2xlLmxvZyhmcmFtZUNvdW50KyspO1xuICAgICAgY29uc29sZS5sb2coXCJGUFM6XCIsIDYwKjEwMDAvKERhdGUubm93KCktdGltZVN0YXJ0KSk7XG4gICAgfSlcbiAgICAvLyBsaXN0ZW5lci5zdGFydCgpO1xuICB9LFxuICAvL+S6i+S7tuWkhOeQhuWHveaVsFxuICBoYW5kbGVGcmFtZSgpIHtcbiAgICBsZXQgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeShjYW1lcmFDb25maWcuZnJhbWUud2lkdGgsIGNhbWVyYUNvbmZpZy5mcmFtZS5oZWlnaHQpOyAvL+efqeW9ouW5s+mdolxuICAgIGxldCB0ZXh0dXJlID0gbmV3IFRIUkVFLkRhdGFUZXh0dXJlKGNhbWVyYUNvbmZpZy5mcmFtZS5kYXRhLCBjYW1lcmFDb25maWcuZnJhbWUud2lkdGgsIGNhbWVyYUNvbmZpZy5mcmFtZS5oZWlnaHQsIFRIUkVFLlJHQkFGb3JtYXQpO1xuXG4gICAgICAvL3RleHR1cmUubmVlZHNVcGRhdGUgPSB0cnVlOyAvL+e6ueeQhuabtOaWsO+8jOS9nOeUqOWtmOeWke+8jOS8vOS5juaYr+ato+S9nOeUqFxuICAgICAgbGV0IHRleF9tYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoUGhvbmdNYXRlcmlhbCh7XG4gICAgICAgIG1hcDogdGV4dHVyZSwgICAgICAgICAvLyDorr7nva7nurnnkIbotLTlm75cbiAgICAgICAgc2lkZTogVEhSRUUuRG91YmxlU2lkZVxuICAgICAgfSk7XG4gICAgICBnZW9tZXRyeS50cmFuc2xhdGUoY2FtZXJhQ29uZmlnLmZyYW1lLndpZHRoLzIsIGNhbWVyYUNvbmZpZy5mcmFtZS5oZWlnaHQvMiwgMCk7XG4gICAgICBnZW9tZXRyeS5yb3RhdGVYKE1hdGguUEkpXG4gICAgICBsZXQgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LCB0ZXhfbWF0ZXJpYWwpO1xuICAgICAgc2NlbmUuYWRkKG1lc2gpO1xuICAgICAgcmVuZGVyZXIucmVuZGVyKHNjZW5lLCBjYW1lcmEpO1xuICAgICAgY2FtZXJhQ29uZmlnLmZsYWcgPSB0cnVlO1xuICB9LFxuICB3ZWJnbEluaXQoKSB7XG4gICAgd3guY3JlYXRlU2VsZWN0b3JRdWVyeSgpLnNlbGVjdCgnI2NhbnZhc0lkJylcbiAgICAubm9kZSgpXG4gICAgLmV4ZWMoKHJlcykgPT4ge1xuICAgICAgbGV0IHdlYmNhbnZhcyA9IHJlc1swXS5ub2RlO1xuICAgICAgbGV0IGsgPSBjYW1lcmFDb25maWcuZnJhbWUud2lkdGggLyBjYW1lcmFDb25maWcuZnJhbWUuaGVpZ2h0O1xuICAgICAgbGV0IHMgPSBjYW1lcmFDb25maWcuZnJhbWUuaGVpZ2h0LzI7XG4gICAgICBjYW1lcmEgPSBuZXcgVEhSRUUuT3J0aG9ncmFwaGljQ2FtZXJhKC1zICogaywgcyAqIGssIHMsIC1zLCAxLCAxNTUpO1xuICAgICAgdmFyIHggPSBjYW1lcmFDb25maWcuZnJhbWUud2lkdGgvMjtcbiAgICAgIHZhciB5ID0gLTEgKiBjYW1lcmFDb25maWcuZnJhbWUuaGVpZ2h0LzI7XG4gICAgICAgIC8v5L2/Y2FtZXJh5q2j5a+55Lit5b+DXG4gICAgICAgIGNhbWVyYS5wb3NpdGlvbi5zZXQoeCwgeSwgMTUwKTtcbiAgICAgICAgY2FtZXJhLmxvb2tBdCh4LCB5LCAwKTtcblxuICAgICAgICByZW5kZXJlciA9IG5ldyBUSFJFRS5XZWJHTFJlbmRlcmVyKHtcbiAgICAgICAgICBjYW52YXM6IHdlYmNhbnZhcyxcbiAgICAgICAgICAvLyBhbnRpYWxpYXM6IHRydWUsLy/lj43plK/pvb9cbiAgICAgICAgICAvLyBhbHBoYTogdHJ1ZS8v6YCP5piOXG4gICAgICAgIH0pO1xuICAgIGxldCBhbWJpZW50ID0gbmV3IFRIUkVFLkFtYmllbnRMaWdodCgweEY1RjVGNSk7XG4gICAgc2NlbmUgPSBuZXcgVEhSRUUuU2NlbmUoKTsgICBcbiAgICBzY2VuZS5hZGQoYW1iaWVudCk7XG4gIH0pO1xufSxcbiAgZnJhbWVTaXplSW5pdCgpIHtcbiAgICBpZih0aGlzLmRhdGEuZnJhbWVTaXplID09PSBcInNtYWxsXCIpe1xuICAgICAgY2FtZXJhQ29uZmlnLmZyYW1lLndpZHRoID0gMjg4O1xuICAgICAgY2FtZXJhQ29uZmlnLmZyYW1lLmhlaWdodCA9IDM1MjtcbiAgICB9IGVsc2UgaWYodGhpcy5kYXRhLmZyYW1lU2l6ZSA9PT0gXCJtZWRpdW1cIil7XG4gICAgICBjYW1lcmFDb25maWcuZnJhbWUud2lkdGggPSA0ODA7XG4gICAgICBjYW1lcmFDb25maWcuZnJhbWUuaGVpZ2h0ID0gNjQwO1xuICAgIH0gZWxzZSBpZih0aGlzLmRhdGEuZnJhbWVTaXplID09PSBcImxhcmdlXCIpe1xuICAgICAgY2FtZXJhQ29uZmlnLmZyYW1lLndpZHRoID0gNzIwO1xuICAgICAgY2FtZXJhQ29uZmlnLmZyYW1lLmhlaWdodCA9IDEyODA7XG4gICAgfVxuICB9XG59KVxuIl19